# æ··æ·†å­¦ä¹ 

## 0. ä¸ºä»€ä¹ˆéœ€è¦æ··æ·†

ä½œä¸ºAndroidå¼€å‘è€…ï¼Œå¦‚æœä½ ä¸æƒ³å¼€æºä½ çš„åº”ç”¨ï¼Œé‚£ä¹ˆåœ¨åº”ç”¨å‘å¸ƒå‰ï¼Œå°±éœ€è¦å¯¹ä»£ç è¿›è¡Œæ··æ·†å¤„ç†ï¼Œä»è€Œè®©æˆ‘ä»¬ä»£ç å³ä½¿è¢«åç¼–è¯‘ï¼Œä¹Ÿéš¾ä»¥é˜…è¯»;

æ··æ·†çš„ä½œç”¨:

ã€ä¼˜åŒ–ã€‘å®ƒèƒ½ä¼˜åŒ–javaçš„å­—èŠ‚ç ï¼Œä½¿ç¨‹åºè¿è¡Œæ›´å¿«ï¼›
ã€å‹ç¼©ã€‘æœ€ç›´è§‚çš„å°±æ˜¯å‡å°‘Appå¤§å°ï¼Œåœ¨æ··æ·†è¿‡ç¨‹ä¸­å®ƒä¼šæ‰¾å‡ºæœªè¢«ä½¿ç”¨è¿‡çš„ç±»å’Œç±»æˆå‘˜å¹¶åˆ é™¤ä»–ä»¬ï¼›
ã€æ··æ·†ã€‘ä½¿javaä»£ç ä¸­çš„ç±»ã€å‡½æ•°ã€å˜é‡åéšæœºå˜æˆæ— æ„ä¹‰çš„ä»£å·å½¢å¦‚ï¼ša,b,c...ä¹‹ç±»ï¼Œå¢åŠ äº†é˜…è¯»çš„å›°éš¾ç¨‹åº¦;

> ä¸Šé¢è¿™å‡ ä¸ªåŠŸèƒ½éƒ½æ˜¯é»˜è®¤æ‰“å¼€çš„ï¼Œè¦å…³é—­ä»–ä»¬åªéœ€é…ç½®è§„åˆ™ï¼š

``` text
-dontshrink    :å…³é—­å‹ç¼©;
-dontoptimize  :å…³é—­ä¼˜åŒ–;
-dontobfuscate :å…³é—­æ··æ·†;
```

## 1. æ··æ·†å‡†å¤‡

* æ–°å»ºä¸€ä¸ªAndroid é¡¹ç›®æ—¶ï¼Œä¼šè‡ªåŠ¨ç”Ÿæˆä¸¤ä¸ªæ–‡ä»¶proguard-project.txt ï¼ŒÂ  project.properties;
* åªéœ€è¦å°†project.propertiesæ–‡ä»¶ä¸­Â  proguard.config=${sdk.dir}/tools/proguard/proguard-android.txt:proguard-project.txt è¿™è¡Œå‰é¢çš„#å»æ‰

**å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š**

![](https://img-blog.csdnimg.cn/20190311181509145.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0NyaWNrZXRfNw==,size_16,color_FFFFFF,t_70)

**æ³¨æ„âš ï¸**

> 1. åªèƒ½é€šè¿‡export signedÂ  Application PackageÂ  æˆ–è€… exportÂ  UnsignedÂ  Application Packageè¿™ä¸¤ç§æ–¹å¼æ‰“åŒ…apkï¼Œæ‰æœ‰ä»£ç æ··æ·†ï¼Œç›´æ¥è¿è¡Œçš„apkæ²¡æœ‰ä»£ç æ··æ·†çš„ã€‚

> 2. proguard.config=${sdk.dir}/tools/proguard/proguard-android.txt:proguard-project.txtï¼Œè¿™è¡Œä»£ç ä¸­ç”¨åˆ°äº†ä¸¤ä¸ªé…ç½®æ–‡ä»¶ï¼Œä¸€ä¸ªæ˜¯sdkç›®å½•ä¸‹çš„**proguard-android.txt**ï¼Œä¸€äº›åŸºæœ¬çš„é…ç½®ï¼Œæ¯”å¦‚ Activity ï¼Œæ³¨è§£ ï¼Œå®ç°æ¥å£ç­‰ä¸è¢«æ··æ·†**ä¸€èˆ¬ä¸ç”¨ä¿®æ”¹**ã€‚å¦ä¸€ä¸ªæ˜¯**proguard-project.txt**ï¼Œä¹‹å‰è¯´çš„æ–°å»ºé¡¹ç›®è‡ªåŠ¨ç”Ÿæˆçš„æ–‡ä»¶ï¼Œè¿™é‡Œä½ éœ€è¦åŠ ä¸Šä¸€äº›ä½ éœ€è¦ä¸è¢«æ··æ·†çš„é…ç½®ã€‚

## 2. æ··æ·†è§„åˆ™

1. Androidé»˜è®¤çš„è§„åˆ™è§£æ

![](pic/proguard_android.png)

**ä¸Šé¢é»˜è®¤çš„è§„åˆ™ä¸­æŒ‡ç¤ºäº†äº›éœ€è¦ä¿æŒä¸èƒ½åˆ«æ··æ·†çš„ä»£ç ï¼ŒåŒ…æ‹¬ï¼š**

1. ç»§æ‰¿è‡³Androidç»„ä»¶ï¼ˆActivity, Service...ï¼‰çš„ç±»ã€‚
2. è‡ªå®šä¹‰æ§ä»¶ï¼Œç»§æ‰¿è‡³Viewçš„ç±»ï¼ˆè¢«xmlæ–‡ä»¶å¼•ç”¨åˆ°çš„ï¼Œåå­—å·²ç»å›ºå®šäº†çš„ï¼‰
3. enum æšä¸¾
4. å®ç°äº† android.os.Parcelable æ¥å£çš„
5. Android Ræ–‡ä»¶
6. æ•°æ®åº“é©±åŠ¨...
7. Android support åŒ…ç­‰
8. Android çš„æ³¨é‡Šä¸èƒ½æ··æ·†
  > -keepattributes *Annotation*
9. å¯¹äºNDKå¼€å‘ æœ¬åœ°çš„nativeæ–¹æ³•ä¸èƒ½è¢«æ··æ·†
  > -keepclasseswithmembernames class * { native <methods>; }

2. è§„åˆ™è¯´æ˜ï¼ˆè‡ªå®šä¹‰æ··æ·†è§„åˆ™ï¼‰

![](pic/custome_proguard.png)

> å‚è€ƒ [Androidä»£ç æ··æ·†å…¥é—¨](https://www.jianshu.com/p/86ee6ef970ef)

3. åŸºæœ¬è§„åˆ™([å‚è€ƒæ¥æº](https://www.jianshu.com/p/7436a1a32891))

* -keepattributes {name}â€ƒâ€ƒä¿æŠ¤ç»™å®šçš„å±æ€§ä¸è¢«æ··æ·†
  å¦‚:`-keepattributes *Annotation*`

* -dontwarn {name}â€ƒâ€ƒä¸è¦è­¦å‘ŠæŒ‡å®šåº“ä¸­æ‰¾ä¸åˆ°çš„å¼•ç”¨ã€‚æ··æ·†åœ¨é»˜è®¤æƒ…å†µä¸‹ä¼šæ£€æŸ¥æ¯ä¸ªåº“çš„å¼•ç”¨æ˜¯å¦æ­£ç¡®ï¼Œä½†æ˜¯æœ‰äº›ç¬¬ä¸‰æ–¹åº“é‡Œé¢ä¼šæœ‰ç”¨ä¸åˆ°çš„ç±»ï¼Œæœ‰äº›æ²¡æœ‰æ­£ç¡®å¼•ç”¨ï¼Œæ‰€ä»¥éœ€è¦å¯¹ç¬¬ä¸‰æ–¹åº“å–æ¶ˆè­¦å‘Š å¦åˆ™ä¼šæŠ¥é”™ï¼Œè€Œä¸”æœ‰å¯èƒ½æ··æ·†æ—¶é—´ä¼šå¾ˆé•¿ã€‚
  å¦‚:`-dontwarn android.support.**`

* -keep {Modifier} {class_specification}â€ƒâ€ƒä¿ç•™æŒ‡å®šçš„ç±»åã€ç±»æˆå‘˜ä¸è¢«æ··æ·†

* -keepclassmembers {modifier} {class_specification} â€ƒâ€ƒä¿ç•™æŒ‡å®šçš„ç±»æˆå‘˜ä¸è¢«æ··æ·†

* -keepclasseswithmembers {class_specification} â€ƒâ€ƒä¿ç•™æŒ‡å®šçš„ç±»åã€ç±»æˆå‘˜ä¸è¢«æ··æ·†

* -keepnames {class_specification} â€ƒâ€ƒä¿ç•™æŒ‡å®šçš„ç±»åã€ç±»æˆå‘˜çš„åç§°ä¸è¢«æ··æ·†

* -keepclasseswithmembernames {class_specification} â€ƒâ€ƒä¿ç•™æŒ‡å®šçš„ç±»åã€ç±»æˆå‘˜åç§°ä¸è¢«æ··æ·†ï¼ˆå¦‚æœå­˜åœ¨çš„è¯ï¼‰

* æœ€å¸¸ç”¨çš„å‘½ä»¤ keep

``` java
-keep class cn.hadcn.test.**
-keep class cn.hadcn.test.*
```

ä¸€é¢—æ˜Ÿè¡¨ç¤ºåªæ˜¯ä¿æŒè¯¥åŒ…ä¸‹çš„ç±»åï¼Œè€Œå­åŒ…ä¸‹çš„ç±»åè¿˜æ˜¯è¢«æ··æ·†ï¼›ä¸¤é¢—æ˜Ÿè¡¨ç¤ºæŠŠæœ¬åŒ…å’Œæ‰€å«å­åŒ…ä¸‹çš„ç±»åéƒ½ä¿æŒï¼›
ä»¥ä¸Šçš„ä¸¤ä¸ªæ–¹æ³•ä¼šä¿æŒç±»åï¼Œä½†æ˜¯é‡Œé¢çš„å…·ä½“æ–¹æ³•åŠå˜é‡åè¿˜æ˜¯è¢«æ··æ·†äº†ï¼Œå¦‚æœå³æƒ³ä¿æŒåŒ…ååˆæƒ³ä¿æŒé‡Œé¢çš„å†…å®¹ä¸è¢«æ··æ·†ï¼Œéœ€è¦ä»¥ä¸‹æ–¹æ³•ï¼š

`-keep class cn.hadcn.test.* {*;}`

åœ¨æ­¤åŸºç¡€ä¸Šï¼Œå¯ä»¥ä½¿ç”¨Javaçš„è¯­æ³•è§„åˆ™ä¿æŠ¤ç‰¹å®šçš„ç±»ä¸è¢«æ··æ·†ï¼Œä¾‹å¦‚ï¼š

`-keep public class * extends android.app.Activity`

å¦‚æœæˆ‘ä»¬è¦ä¿ç•™ä¸€ä¸ªç±»ä¸­çš„å†…éƒ¨ç±»ä¸è¢«æ··æ·†åˆ™éœ€è¦ç”¨$ç¬¦å·ï¼Œå¦‚ä¸‹ä¾‹å­è¡¨ç¤ºä¿æŒScriptFragmentå†…éƒ¨ç±»JavaScriptInterfaceä¸­çš„æ‰€æœ‰publicå†…å®¹ä¸è¢«æ··æ·†ã€‚

``` java
-keepclassmembers class cc.ninty.chat.ui.fragment.ScriptFragment$JavaScriptInterface {
   public *;
}
```

å¦‚æœå¸Œæœ›ä¿æŠ¤ç±»ä¸­çš„æŸäº›ç‰¹å®šçš„æ–¹æ³•ä¸è¢«æ··æ·†ï¼Œåˆ™éœ€è¦ä½¿ç”¨ï¼š

``` java
<init>;     //åŒ¹é…æ‰€æœ‰æ„é€ å™¨
<fields>;    //åŒ¹é…æ‰€æœ‰åŸŸ
<methods>;  //åŒ¹é…æ‰€æœ‰æ–¹æ³•æ–¹æ³•
```

è¿˜å¯ä»¥åœ¨<fields>æˆ–<methods>å‰é¢åŠ ä¸Šprivate ã€publicã€nativeç­‰æ¥è¿›ä¸€æ­¥æŒ‡å®šä¸è¢«æ··æ·†çš„å†…å®¹ï¼Œå¦‚ï¼š

```java
-keep class cn.hadcn.test.One {
    public <methods>;
}
```
è¡¨ç¤ºOneç±»ä¸‹çš„æ‰€æœ‰publicæ–¹æ³•éƒ½ä¸ä¼šè¢«æ··æ·†ï¼Œå½“ç„¶ä½ è¿˜å¯ä»¥åŠ å…¥å‚æ•°ï¼Œæ¯”å¦‚ä»¥ä¸‹è¡¨ç¤ºç”¨JSONObjectä½œä¸ºå…¥å‚çš„æ„é€ å‡½æ•°ä¸ä¼šè¢«æ··æ·†

```java
-keep class cn.hadcn.test.One {
   public <init>(org.json.JSONObject);
}
```

æœ‰æ—¶å€™ä¸éœ€è¦ä¿æŒç±»åï¼Œåªéœ€è¦æŠŠè¯¥ç±»ä¸‹çš„ç‰¹å®šæ–¹æ³•ä¿æŒä¸è¢«æ··æ·†å°±å¥½ï¼Œé‚£å°±ä¸èƒ½ç”¨keepæ–¹æ³•äº†ï¼Œkeepæ–¹æ³•ä¼šä¿æŒç±»åï¼Œè€Œéœ€è¦ç”¨keepclassmembers ï¼Œå¦‚æ­¤ç±»åå°±ä¸ä¼šè¢«ä¿æŒï¼Œä¸ºäº†ä¾¿äºå¯¹è¿™äº›è§„åˆ™è¿›è¡Œç†è§£ï¼Œå®˜ç½‘ç»™å‡ºäº†ä»¥ä¸‹è¡¨æ ¼:

ä¿ç•™	| é˜²æ­¢è¢«ç§»é™¤æˆ–è€…è¢«é‡å‘½å |	é˜²æ­¢è¢«é‡å‘½å
:-:|:-:|:-:|
ç±»å’Œç±»æˆå‘˜|	-keep	|-keepnames
ä»…ç±»æˆå‘˜	|-keepclassmembers|	-keepclassmembernames
å¦‚æœæ‹¥æœ‰æŸæˆå‘˜ï¼Œä¿ç•™ç±»å’Œç±»æˆå‘˜|	-keepclasseswithmembers	|-keepclasseswithmembernames


## 3.æ³¨æ„äº‹é¡¹ğŸ“‹

1. jniæ–¹æ³•ä¸å¯ä»¥æ··æ·†ï¼Œå› ä¸ºè¿™ä¸ªæ–¹æ³•éœ€è¦å’Œnativeæ–¹æ³•ä¿æŒä¸€è‡´

```java
-keepclasseswithmembernames class * { # ä¿æŒnativeæ–¹æ³•ä¸è¢«æ··æ·†    
    native <methods>;
}
```

2. åå°„ç”¨åˆ°çš„ç±»ä¸æ··æ·†(å¦åˆ™åå°„æ‰¾ä¸åˆ°æ­£ç¡®çš„æ–¹æ³•)

3. AndroidMainfestä¸­çš„ç±»ä¸æ··æ·†ï¼Œæ‰€ä»¥å››å¤§ç»„ä»¶å’ŒApplicationçš„å­ç±»å’ŒFrameworkå±‚ä¸‹æ‰€æœ‰çš„ç±»é»˜è®¤ä¸ä¼šè¿›è¡Œæ··æ·†;è‡ªå®šä¹‰çš„Viewé»˜è®¤ä¹Ÿä¸ä¼šè¢«æ··æ·†.

4. ä¸æœåŠ¡ç«¯äº¤äº’æ—¶ï¼Œä½¿ç”¨GSONã€fastjsonç­‰æ¡†æ¶è§£ææœåŠ¡ç«¯æ•°æ®æ—¶ï¼Œæ‰€å†™çš„JSONå¯¹è±¡ç±»ä¸æ··æ·†ï¼Œå¦åˆ™æ— æ³•å°†JSONè§£ææˆå¯¹åº”çš„å¯¹è±¡ï¼›

5. ä½¿ç”¨ç¬¬ä¸‰æ–¹å¼€æºåº“æˆ–è€…å¼•ç”¨å…¶ä»–ç¬¬ä¸‰æ–¹çš„SDKåŒ…æ—¶ï¼Œå¦‚æœæœ‰ç‰¹åˆ«è¦æ±‚ï¼Œä¹Ÿéœ€è¦åœ¨æ··æ·†æ–‡ä»¶ä¸­åŠ å…¥å¯¹åº”çš„æ··æ·†è§„åˆ™ï¼›

6. æœ‰ç”¨åˆ°WebViewçš„JSè°ƒç”¨ä¹Ÿéœ€è¦ä¿è¯å†™çš„æ¥å£æ–¹æ³•ä¸æ··æ·†ï¼ŒåŸå› å’Œç¬¬ä¸€æ¡ä¸€æ ·ï¼›

7. Parcelableçš„å­ç±»å’ŒCreatoré™æ€æˆå‘˜å˜é‡ä¸æ··æ·†ï¼Œå¦åˆ™ä¼šäº§ç”ŸAndroid.os.BadParcelableExceptionå¼‚å¸¸ï¼›

```java
-keep class * implements Android.os.Parcelable { # ä¿æŒParcelableä¸è¢«æ··æ·†           
    public static final Android.os.Parcelable$Creator *;
}
```

8. ä½¿ç”¨enumç±»å‹æ—¶éœ€è¦æ³¨æ„é¿å…ä»¥ä¸‹ä¸¤ä¸ªæ–¹æ³•æ··æ·†ï¼Œå› ä¸ºenumç±»çš„ç‰¹æ®Šæ€§ï¼Œä»¥ä¸‹ä¸¤ä¸ªæ–¹æ³•ä¼šè¢«åå°„è°ƒç”¨ï¼Œè§ç¬¬äºŒæ¡è§„åˆ™.

```java
-keepclassmembers enum * {  
    public static **[] values();  
    public static ** valueOf(java.lang.String);  
}
```