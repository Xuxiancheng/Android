#  Androidåº”ç”¨å´©æºƒå¤„ç†

##  ä¸€.å‰è¨€ğŸ’¬

åœ¨å¼€å‘Androidçš„è¿‡ç¨‹ä¸­ï¼Œéœ€è¦æ‰“å°æ—¥å¿—ğŸ–¨ï¸ï¼Œè¿‡å¤šçš„æ—¥å¿—æ‰“å°å°¤å…¶æ˜¯æˆ‘ä»¬éœ€è¦å°†è¿™äº›æ—¥å¿—ä¿å­˜ä¸ºæ–‡æœ¬ï¼Œåˆ™ä¼šå½±å“åº”ç”¨æ€§èƒ½ã€‚å› æ­¤æˆ‘ä»¬éœ€è¦åœ¨äº§å“å‘å¸ƒåå°†æ—¥å¿—æ‰“å°çš„åŠŸèƒ½å…³é—­ã€‚ä½†æ˜¯æœ‰ä¸€ä¸ªé—®é¢˜å°±æ˜¯æ— è®ºæˆ‘ä»¬åœ¨äº§å“å‘å¸ƒå‰å†™çš„å¤šä¹ˆå®Œç¾ï¼Œäº§å“å‘å¸ƒåæ€»ä¼šæœ‰å´©æºƒçš„é—®é¢˜å‘ç”Ÿï¼Œä½†æ˜¯å¦‚æœå°†æ—¥å¿—æ‰“å¼€åˆä¼šè€—è´¹æ€§èƒ½ï¼Œå› æ­¤å¦‚ä½•æ•æ‰åº”ç”¨å´©æºƒçš„æ—¥å¿—å°±éå¸¸é‡è¦ã€‚

##  äºŒ.åŸç†ğŸ³

Android ç³»ç»Ÿæä¾›äº†å¤„ç†è¿™ç±»é—®é¢˜çš„æ–¹æ³•ï¼ŒThread ç±»ä¸­æä¾›äº†ä¸€ä¸ªæ–¹æ³• **setDefaultUncaughtExceptionHandler**ï¼Œè®¾ç½®äº†è¿™ä¸ªé»˜è®¤çš„å¼‚å¸¸å¤„ç†å™¨ä¹‹åå½“ç¨‹åºå‘ç”Ÿå¼‚å¸¸ä¹‹åå°±ä¼šå›è°ƒ**uncaugthExceptionï¼ˆï¼‰**è¿™ä¸ªæ–¹æ³•ï¼Œç„¶åå¯ä»¥åœ¨è¿™ä¸ªå›è°ƒé‡Œé¢æ•è·å¼‚å¸¸ä¿¡æ¯ï¼Œä¿å­˜åˆ°æ–‡ä»¶ã€‚

## ä¸‰.å¤„ç†ğŸ¦€ï¸

### 1.è‡ªå®šä¹‰ç±»å®ç°Thread.UncaughtExceptionHandlerä¸­çš„æ–¹æ³•

###  2. å°†è‡ªå®šä¹‰ç±»æ”¾å…¥Applicationä¸­çš„å…¥å£ï¼Œå°±å¯ä»¥æ•è·å…¨å±€å¼‚å¸¸



> åœ¨æ¸…å•æ–‡ä»¶ä¸­ğŸ§¾ï¼š
>
> ```xml
> <activity
>           android:name="com.android.application"
>           ...
>           />
> ```
>
> `name`ä¸­çš„å°±æ˜¯åº”ç”¨çš„å…¥å£ç±»ï¼Œåº”ç”¨å¯åŠ¨æ—¶éƒ½ä¼šå…ˆåœ¨æ­¤åˆå§‹åŒ–ã€‚



 **æ ¸å¿ƒä»£ç **

CrashHandlerUtilsç±»:

```java
public class CrashHandlerUtils implements Thread.UncaughtExceptionHandler {
    private static final String TAG = "CrashHandlerUtils";
    //ç³»ç»Ÿé»˜è®¤çš„UncaughtExceptionå¤„ç†ç±»
    private Thread.UncaughtExceptionHandler mDefaultHandler;
    //CrashHandlerå®ä¾‹
    private static CrashHandlerUtils INSTANCE = new CrashHandlerUtils();
    //ç¨‹åºçš„Contextå¯¹è±¡
    private Context mContext;
    //ç”¨æ¥å­˜å‚¨è®¾å¤‡ä¿¡æ¯å’Œå¼‚å¸¸ä¿¡æ¯
    private String crashTip = "ä¼¼ä¹é‡åˆ°äº†ä¸€ç‚¹å°éº»çƒ¦ï¼Œç¨‹åºå³å°†é‡æ–°å¯åŠ¨";
    /**
     * æ–‡ä»¶å
     */
    public static final String FILE_NAME = "crash";
    /**
     * å¼‚å¸¸æ—¥å¿— å­˜å‚¨ä½ç½®ä¸ºæ ¹ç›®å½•ä¸‹çš„ Crashæ–‡ä»¶å¤¹
     */
    private static final String PATH = Environment.getExternalStorageDirectory().getPath() +
            "/Supreme_crash/";
    /**
     * æ–‡ä»¶ååç¼€
     */
    private static final String FILE_NAME_SUFFIX = ".txt";

    public String getCrashTip() {
        return crashTip;
    }

    public void setCrashTip(String crashTip) {
        this.crashTip = crashTip;
    }

    /**
     * ä¿è¯åªæœ‰ä¸€ä¸ªCrashHandlerå®ä¾‹
     */
    private CrashHandlerUtils() {
    }

    /**
     * è·å–CrashHandlerå®ä¾‹ ,å•ä¾‹æ¨¡å¼
     *
     * @return å•ä¾‹
     */
    public static CrashHandlerUtils getInstance() {
        return INSTANCE;
    }

    /**
     * åˆå§‹åŒ–
     *
     * @param context ä¸Šä¸‹æ–‡
     */
    public void init(Context context) {
        mContext = context;
        //è·å–ç³»ç»Ÿé»˜è®¤çš„UncaughtExceptionå¤„ç†å™¨
        mDefaultHandler = Thread.getDefaultUncaughtExceptionHandler();
        //è®¾ç½®è¯¥CrashHandlerä¸ºç¨‹åºçš„é»˜è®¤å¤„ç†å™¨
        Thread.setDefaultUncaughtExceptionHandler(this);
    }

    /**
     * è¿™ä¸ªæ˜¯æœ€å…³é”®çš„å‡½æ•°ï¼Œå½“ç³»ç»Ÿä¸­æœ‰æœªè¢«æ•è·çš„å¼‚å¸¸ï¼Œç³»ç»Ÿå°†ä¼šè‡ªåŠ¨è°ƒç”¨ uncaughtException æ–¹æ³•
     *
     * @param thread ä¸ºå‡ºç°æœªæ•è·å¼‚å¸¸çš„çº¿ç¨‹
     * @param ex     ä¸ºæœªæ•è·çš„å¼‚å¸¸ ï¼Œå¯ä»¥é€šè¿‡e æ‹¿åˆ°å¼‚å¸¸ä¿¡æ¯
     */
    @Override
    public void uncaughtException(Thread thread, final Throwable ex) {
        //å¯¼å…¥å¼‚å¸¸ä¿¡æ¯åˆ°SDå¡ä¸­
        try {
            dumpExceptionToSDCard(ex);
        } catch (IOException e) {
            e.printStackTrace();
        }
        //è¿™é‡Œå¯ä»¥ä¸Šä¼ å¼‚å¸¸ä¿¡æ¯åˆ°æœåŠ¡å™¨ï¼Œä¾¿äºå¼€å‘äººå‘˜åˆ†ææ—¥å¿—ä»è€Œè§£å†³Bug
//        uploadExceptionToServer();
        ex.printStackTrace();
        //å¦‚æœç³»ç»Ÿæä¾›äº†é»˜è®¤çš„å¼‚å¸¸å¤„ç†å™¨ï¼Œåˆ™äº¤ç»™ç³»ç»Ÿå»ç»“æŸç¨‹åºï¼Œå¦åˆ™å°±ç”±è‡ªå·±ç»“æŸè‡ªå·±
        if (mDefaultHandler != null) {
            mDefaultHandler.uncaughtException(thread, ex);
        } else {
            android.os.Process.killProcess(android.os.Process.myPid());
            System.exit(1);
        }

    }


    /**
     * å°†å¼‚å¸¸ä¿¡æ¯å†™å…¥SDå¡
     *
     * @param e
     */
    private void dumpExceptionToSDCard(Throwable e) throws IOException {
        //å¦‚æœSDå¡ä¸å­˜åœ¨æˆ–æ— æ³•ä½¿ç”¨ï¼Œåˆ™æ— æ³•å°†å¼‚å¸¸ä¿¡æ¯å†™å…¥SDå¡
        if (!Environment.getExternalStorageState().equals(Environment.MEDIA_MOUNTED)) {
            if (DEBUG) {
                Log.w(TAG, "sdcard unmounted,skip dump exception");
                return;
            }
        }
        File dir = new File(PATH);
        //å¦‚æœç›®å½•ä¸‹æ²¡æœ‰æ–‡ä»¶å¤¹ï¼Œå°±åˆ›å»ºæ–‡ä»¶å¤¹
        if (!dir.exists()) {
            dir.mkdirs();
        }
        //å¾—åˆ°å½“å‰å¹´æœˆæ—¥æ—¶åˆ†ç§’
        long current = System.currentTimeMillis();
        String time = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss").format(new Date(current));
        //åœ¨å®šä¹‰çš„Crashæ–‡ä»¶å¤¹ä¸‹åˆ›å»ºæ–‡ä»¶
        File file = new File(PATH + FILE_NAME + time + FILE_NAME_SUFFIX);

        try {
            PrintWriter pw = new PrintWriter(new BufferedWriter(new FileWriter(file)));
            //å†™å…¥æ—¶é—´
            pw.println(time);
            //å†™å…¥æ‰‹æœºä¿¡æ¯
            dumpPhoneInfo(pw);
            pw.println();//æ¢è¡Œ
            e.printStackTrace(pw);
            pw.close();//å…³é—­è¾“å…¥æµ
        } catch (Exception e1) {
            Log.e(TAG, "dump crash info failed");
        }

    }

    /**
     * è·å–æ‰‹æœºå„é¡¹ä¿¡æ¯
     *
     * @param pw
     */
    private void dumpPhoneInfo(PrintWriter pw) throws PackageManager.NameNotFoundException {
        //å¾—åˆ°åŒ…ç®¡ç†å™¨
        PackageManager pm = mContext.getPackageManager();
        //å¾—åˆ°åŒ…å¯¹è±¡
        PackageInfo pi = pm.getPackageInfo(mContext.getPackageName(), PackageManager.GET_ACTIVITIES);
        //å†™å…¥APPç‰ˆæœ¬å·
        pw.print("App Version: ");
        pw.print(pi.versionName);
        pw.print("_");
        pw.println(pi.versionCode);
        //å†™å…¥ Android ç‰ˆæœ¬å·
        pw.print("OS Version: ");
        pw.print(Build.VERSION.RELEASE);
        pw.print("_");
        pw.println(Build.VERSION.SDK_INT);
        //æ‰‹æœºåˆ¶é€ å•†
        pw.print("Vendor: ");
        pw.println(Build.MANUFACTURER);
        //æ‰‹æœºå‹å·
        pw.print("Model: ");
        pw.println(Build.MODEL);
        //CPUæ¶æ„
        pw.print("CPU ABI: ");
        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.LOLLIPOP) {
            pw.println(Build.SUPPORTED_ABIS);
        } else {
            pw.println(Build.CPU_ABI);
        }
    }

}
```

åœ¨Applicationä¸­`onCreate`åˆå§‹åŒ–:

```java
public class MyApplication extends Application{

  public void onCreate(){
    super.onCreate();
    CrashHandlerUtils.getInstance.init();
  }
  ...
}
```

##  å››.å¤‡æ³¨ğŸ“

é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜å»ºè®®æºå¸¦ä»¥ä¸‹ä¿¡æ¯å‘é€åˆ°æœåŠ¡å™¨ï¼Œå¸®åŠ©æ›´å¿«å®šä½å’Œé‡ç°é—®é¢˜ã€‚

- è®¾å¤‡å”¯ä¸€IDï¼ˆåŸºäºIMEIæˆ–è€…Android IDç­‰ï¼‰ï¼Œæ–¹ä¾¿æ ¹æ®ç”¨æˆ·æä¾›çš„idï¼ŒæŸ¥æ‰¾å´©æºƒçš„stacktrace
- è®¾å¤‡è¯­è¨€ä¸åŒºåŸŸ æ–¹ä¾¿é‡ç°
- åº”ç”¨çš„ç‰ˆæœ¬å·
- è®¾å¤‡çš„ç³»ç»Ÿç‰ˆæœ¬
- è®¾å¤‡ç±»å‹ï¼Œå¦‚å¹³æ¿ï¼Œæ‰‹æœºï¼ŒTVç­‰
- å´©æºƒå‘ç”Ÿçš„æ—¶é—´ç­‰